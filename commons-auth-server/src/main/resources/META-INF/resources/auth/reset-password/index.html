<html>
<head>
    <title>Reset-Password</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
</head>
<body class="p-4 px-3 py-10 bg-grey-lighter flex justify-center">


<div class="w-full max-w-xs">
    <form class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4" id="changePwForm">
        <div class="mb-3">
            <label class="block text-grey-darker text-sm font-bold mb-2" for="pwd">
                Password
            </label>
            <input autocomplete="off"
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-grey-darker mb-3" id="pwd" name="new-password" type="password">
        </div>
        <div class="mb-6">
            <label class="block text-grey-darker text-sm font-bold mb-2" for="pwdAgain">
                Password Again
            </label>
            <input autocomplete="off"
                   class="shadow appearance-none border rounded w-full py-2 px-3 text-grey-darker mb-3" id="pwdAgain" name="again-password" type="password">
        </div>


        <div class="bg-red border text-red-dark border-red-light rounded-b bg-red-lightest rounded text-sm px-4 py-3 mb-6 hidden"
             id="toast" role="alert">
        </div>


        <div class="flex justify-center">
            <button class="bg-blue hover:bg-blue-dark text-white font-bold py-2 px-4 rounded" id="submit" type="submit">
                change password
            </button>
        </div>
    </form>
</div>

<script>
  var toast_el = document.getElementById('toast')
  var form_el = document.getElementById('changePwForm')

  var getParams = function (url) {
    var params = {}
    var parser = document.createElement('a')
    parser.href = url
    var query = parser.search.substring(1)
    var vars = query.split('&')
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=')
      params[pair[0]] = decodeURIComponent(pair[1])
    }
    return params
  }

  var handleToast = function (show, text) {
    if (show) {
      toast_el.classList.remove('hidden')
      toast_el.innerHTML = (text !== null ? text : '')
    } else {
      toast_el.classList.add('hidden')
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    if (!getParams(window.location.href).hasOwnProperty('verification')) {
      handleToast(true, 'verification is missing!')
      var button = document.getElementById('submit')
      button.classList = 'cursor-not-allowed'
      button.disabled = true
    }
  })

  form_el.addEventListener('submit', function (evt) {
    evt.preventDefault()

    var pwd = document.getElementById('pwd').value
    var pwdAgain = document.getElementById('pwdAgain').value

    if (pwd !== pwdAgain) {
      handleToast(true, 'passwords are not equal!')
    } else {
      handleToast(false)
      axios.put('http://localhost:8080/auth/reset-password', {
        'verification': getParams(window.location.href).verification,
        'password': pwd
      })
        .then(function (response) {
          window.location.href = '/auth/reset-password/success.html'
          console.log('response', response)
        })
        .catch(function (error) {
          try {
            var status = error.response.data.status
            if (status === 1000) {
              handleToast(true, error.response.data.fields.password)
            } else if (status === 1011) {
              handleToast(true, 'link is invalid - please request new by email')
            }
          } catch (e) {
            handleToast(true, 'could not perform change - server answered with error')
            console.error('server-error', error, e)
          }
        })
    }
  })
</script>
</body>
</html>